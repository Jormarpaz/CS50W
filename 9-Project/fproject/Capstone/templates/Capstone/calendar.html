{% extends "Capstone/layout.html" %}
{% load static %}
{% block body %}
<div class="container mt-4">
  <div>
    <div id="calendar"></div>
  </div>
  
  <!-- Formulario de añadir evento oculto -->
  <form
    id="event-form"
    style="
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    "
  >
    <div class="form-group">
      <label for="event-title">Título del evento:</label>
      <input
        type="text"
        id="event-title"
        class="form-control input-no-outline"
        placeholder="Introduce el título del evento"
        autocomplete="off"
      />
    </div>
    <div class="form-group">
      <label for="event-start">Hora de inicio:</label>
      <input type="time" id="event-start" class="form-control input-no-outline" />
    </div>
    <div class="form-group">
      <label for="event-end">Hora de finalización:</label>
      <input type="time" id="event-end" class="form-control input-no-outline" />
    </div>
    <div class="form-group">
      <label for="event-all-day">Todo el día:</label>
      <input
        type="checkbox"
        id="event-all-day"
        class="form-control input-no-outline"
        onchange="localStorage.setItem('eventAllDay', this.checked)"
      />
    </div>
    <button type="submit" class="btn btn-primary">Añadir evento</button>
    <button
      type="button"
      class="btn btn-secondary"
      onclick="document.getElementById('event-form').style.display='none'"
    >
      Cancelar
    </button>
  </form>
</div>
<!--<script src="{% static 'js/calendar.js' %}"></script>-->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
        },
        initialView: "dayGridMonth",
        editable: true,
        selectable: true,
        unselectAuto: true,
        events: JSON.parse('{{ events_data|safe }}'),  // Usar los eventos desde la base de datos
        dateClick: function (info) {
            // Mostrar el formulario para añadir un evento
            var form = document.getElementById("event-form");
            form.style.display = "block";

            // Prellenar la fecha seleccionada
            var selectedDate = info.dateStr;  // Fecha en formato YYYY-MM-DD
            document.getElementById("event-start").value = selectedDate + "T00:00";
            document.getElementById("event-end").value = selectedDate + "T23:59";

            // Manejar el envío del formulario
            form.onsubmit = function (event) {
                event.preventDefault();
                var title = document.getElementById("event-title").value;
                var start = document.getElementById("event-start").value;
                var end = document.getElementById("event-end").value;
                var allDay = document.getElementById("event-all-day").checked;

                // Si es "todo el día", no necesitamos start y end
                if (allDay) {
                    start = selectedDate;  // Solo la fecha (sin hora)
                    end = null;          // No hay hora de fin
                }

                if (title) {
                    // Enviar los datos al servidor usando Fetch API
                    fetch("{% url 'calendar' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            title: title,
                            start: start,  // Formato: "YYYY-MM-DD" (si es allDay) o "YYYY-MM-DDTHH:MM"
                            end: end,      // Formato: "YYYY-MM-DD" (si es allDay) o "YYYY-MM-DDTHH:MM"
                            allDay: allDay,
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            calendar.refetchEvents();  // Recargar los eventos en el calendario
                            location.reload();
                            form.style.display = "none";
                        } else {
                            alert("Error al guardar el evento: " + JSON.stringify(data.errors));
                        }
                    });
                }
            };
        },
    });
    calendar.render();
});
</script>
{% endblock %}
